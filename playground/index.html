<!DOCTYPE html>
<html lang="es">

<head>
  <title>Velin Playground</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Velin (All) -->
  <script src="velin.js"></script>
  <!-- Tailwind CSS -->
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <!-- Prism Dark Theme -->
  <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.css" rel="stylesheet" />
  <!-- Prism JS core + HTML support -->
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-markup.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-javascript.min.js"></script>
  <!-- Prettier -->
  <script src="https://cdn.jsdelivr.net/npm/prettier@3.2.5/standalone.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prettier@3.2.5/plugins/html.js"></script>
</head>

<body class="bg-gray-900 text-gray-100 h-screen overflow-hidden flex flex-col font-sans">
  <!-- Header -->
  <header class="bg-gray-800 border-b border-gray-700 px-6 py-4 flex-shrink-0">
    <h1 class="text-2xl font-bold text-indigo-400">Velin Playground</h1>
    <p class="text-sm text-gray-400 mt-1">Interactive examples with live state inspection</p>
  </header>

  <!-- Tabs -->
  <nav class="bg-gray-800 border-b border-gray-700 px-6 flex-shrink-0 overflow-x-auto">
    <div class="flex space-x-1">
      <button
        vln-loop:tab="tabs"
        vln-on:click="selectTab(tab.id)"
        vln-class="{ 'bg-gray-700 text-white border-b-2 border-indigo-500': currentTab === tab.id, 'text-gray-400 hover:text-gray-200 hover:bg-gray-750': currentTab !== tab.id }"
        vln-text="tab.title"
        class="px-4 py-3 font-medium text-sm transition-colors whitespace-nowrap">
      </button>
    </div>
  </nav>

  <!-- 4-Quadrant Grid -->
  <main class="flex-1 grid grid-cols-2 grid-rows-2 gap-4 p-6 overflow-hidden">
    <!-- Top-Left: Original HTML -->
    <section class="bg-gray-800 rounded-lg border border-gray-700 flex flex-col overflow-hidden">
      <header class="px-4 py-2 bg-gray-750 border-b border-gray-700 flex-shrink-0">
        <h2 class="text-sm font-semibold text-gray-300">Original HTML</h2>
      </header>
      <div class="flex-1 overflow-auto p-4 text-xs" vln-html="currentExample.originalHtml"></div>
    </section>

    <!-- Top-Right: Interpolated HTML -->
    <section class="bg-gray-800 rounded-lg border border-gray-700 flex flex-col overflow-hidden">
      <header class="px-4 py-2 bg-gray-750 border-b border-gray-700 flex-shrink-0">
        <h2 class="text-sm font-semibold text-gray-300">Interpolated HTML</h2>
      </header>
      <div class="flex-1 overflow-auto p-4 text-xs" vln-html="currentExample.interpolatedHtml"></div>
    </section>

    <!-- Bottom-Left: State Dump -->
    <section class="bg-gray-800 rounded-lg border border-gray-700 flex flex-col overflow-hidden">
      <header class="px-4 py-2 bg-gray-750 border-b border-gray-700 flex-shrink-0">
        <h2 class="text-sm font-semibold text-gray-300">State</h2>
      </header>
      <div class="flex-1 overflow-auto p-4 text-xs" id="state-dump"></div>
    </section>

    <!-- Bottom-Right: Live Render -->
    <section class="bg-gray-800 rounded-lg border border-gray-700 flex flex-col overflow-hidden">
      <header class="px-4 py-2 bg-gray-750 border-b border-gray-700 flex-shrink-0">
        <h2 class="text-sm font-semibold text-gray-300">Live Render</h2>
      </header>
      <div class="flex-1 overflow-auto p-4" id="live-render" vln-fragment="currentExample.templateId"></div>
    </section>
  </main>

  <!-- Hidden: Example definitions -->
  <div style="display:none;" id="example-definitions">
    <div vln-diff="Text interpolation">
      <div vln-text="username" class="text-xl font-semibold text-indigo-400"></div>
    </div>

    <div vln-diff="Input reactivity">
      <label for="login" class="mr-2 font-medium">Is logged in?</label>
      <input name="login" vln-input="isLoggedIn" type="checkbox" checked class="mr-2" />
      <div vln-text="isLoggedIn ? 'Logged In' : 'Disconnected'" class="inline font-semibold text-green-400"></div>
    </div>

    <div vln-diff="Visibility control">
      <div vln-if="isLoggedIn" class="text-green-400 font-bold text-lg">Welcome!</div>
    </div>

    <div vln-diff="Attribute binding">
      <input vln-input="tooltipText" type="text" placeholder="Enter tooltip text"
        class="border border-gray-600 rounded px-2 py-1 mr-2 bg-gray-700 text-gray-100" />
      <span vln-attr:title="tooltipText" class="underline cursor-help text-indigo-400">I have a tooltip!</span>
    </div>

    <div vln-diff="Class reactivity">
      <div class="space-y-4">
        <div class="flex items-center gap-4">
          <label for="active" class="cursor-pointer">Active</label>
          <input name="active" vln-input="isActive" type="checkbox" checked class="cursor-pointer" />
          <label for="enabled" class="cursor-pointer">Enabled</label>
          <input name="enabled" vln-input="isEnabled" type="checkbox" checked class="cursor-pointer" />
        </div>
        <div vln-class="{ active: isActive, disabled: !isEnabled }"
          class="p-3 rounded border border-gray-600 transition-colors duration-200">
          This should have
          <span vln-text="grabClasses(isActive, isEnabled)" class="font-mono text-indigo-400"></span>
          classes
        </div>
      </div>
    </div>

    <div vln-diff="Loops">
      <ul class="list-disc list-inside space-y-1">
        <li vln-loop:friend="friends" vln-text="friend.name" class="hover:text-indigo-400 cursor-default"></li>
      </ul>
    </div>

    <div vln-diff="Events">
      <button
        class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded transition cursor-pointer"
        vln-on:click="update()">
        Randomize friends!
      </button>
    </div>

    <div vln-diff="Templates">
      <template id="friendCard" vln-vars="friend">
        <div class="p-4 mb-4 rounded-lg bg-gray-700 border border-gray-600">
          <div class="text-lg font-semibold mb-2 text-indigo-400">
            <span vln-text="friend.name"></span>
          </div>
          <div class="text-sm text-gray-300 space-y-1">
            <div><strong>Age:</strong> <span vln-text="friend.age"></span></div>
            <div>
              <strong>Email:</strong>
              <a vln-text="friend.email" vln-attr:href="'mailto:' + friend.email"
                class="text-indigo-400 underline hover:text-indigo-300"></a>
            </div>
            <div vln-if="friend.pets.length">
              <strong>Pets:</strong>
              <ul class="list-disc list-inside ml-4">
                <li vln-loop:pet="friend.pets" vln-text="pet"></li>
              </ul>
            </div>
          </div>
        </div>
      </template>
      <div>
        <div vln-loop:friend_obj="friends" vln-fragment="'friendCard'" vln-var:friend="friend_obj"></div>
      </div>
    </div>
  </div>
</body>
<script type="application/javascript">
  const friends = [
    { name: "John", age: 30, email: "johnyboy@velin.com", pets: ['dog', 'cat'] },
    { name: "Jane", age: 27, email: "jane.doe@velin.com", pets: ['parrot'] },
    { name: "Maurice", age: 35, email: "maurice_the_beast@velin.com", pets: ['iguana', 'hamster'] },
    { name: "Heidi", age: 29, email: "heidi.codes@velin.com", pets: [] },
    { name: "Sheb", age: 41, email: "sheb@velin.com", pets: ['turtle', 'cat'] }
  ];

  function slugify(str) {
    return str.toLowerCase().trim().replace(/[^a-z0-9 -]/g, '').replace(/\s+/g, '-').replace(/-+/g, '-');
  }

  function slugToCamel(str) {
    return str.toLowerCase().replace(/-([a-z0-9])/g, (_, char) => char.toUpperCase());
  }

  // Register vln-diff plugin to capture examples
  Velin.plugins.registerPlugin({
    name: 'diff',
    priority: Velin.plugins.priorities.STOPPER,
    render: ({ reactiveState, node, expr }) => {
      const id = slugify(expr);
      const templateId = slugToCamel(id) + 'Tpl';

      // Create template dynamically
      const template = document.createElement('template');
      template.id = templateId;
      template.innerHTML = node.innerHTML;

      const varsAttr = node.getAttribute('vln-vars');
      if (varsAttr) {
        template.setAttribute('vln-vars', varsAttr);
      }

      if (!document.getElementById(templateId)) {
        document.body.appendChild(template);
      }

      // Store example metadata
      if (!reactiveState.state.examples) {
        reactiveState.state.examples = [];
      }

      const exampleIndex = reactiveState.state.examples.length;
      reactiveState.state.examples.push({
        id,
        title: expr,
        templateId,
        originalHtml: null,
        interpolatedHtml: null,
      });

      // Capture HTML after render
      const renderContainerId = `render-${id}`;
      setTimeout(() => {
        const renderContainer = document.getElementById(renderContainerId);
        if (renderContainer) {
          const example = reactiveState.state.examples[exampleIndex];
          example.interpolatedHtml = renderContainer.innerHTML;
        }
      }, 100);

      return { halt: true };
    }
  });

  // Register vln-html plugin for syntax highlighting
  Velin.plugins.registerPlugin({
    name: 'html',
    track: Velin.trackers.expressionTracker,
    render: ({ node, tracked }) => {
      prettier.format(tracked || '', {
        parser: 'html',
        plugins: prettierPlugins
      }).then(formatted => {
        const escaped = formatted
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
        node.innerHTML = `<pre><code class="language-markup">${escaped}</code></pre>`;
        Prism.highlightAllUnder(node);
      });
    }
  });

  // Initialize state
  const bound = Velin.bind(document.body, {
    // Core data
    username: "Alex",
    isLoggedIn: true,
    tooltipText: "Hello, hover over me!",
    isActive: true,
    isEnabled: false,
    friends: friends.slice(0, 2),
    someClass: "nice-class",
    classObject: { "this-class": true, "not-this-one": false },

    // UI state
    examples: [],
    tabs: [],
    currentTab: null,
    currentExample: {
      originalHtml: '',
      interpolatedHtml: '',
      templateId: '',
    },

    // Functions
    grabClasses: (isActive, isEnabled) => {
      let arr = [isActive ? 'active' : null, !isEnabled ? 'disabled' : null].filter(c => !!c);
      return arr.length ? arr.join(' and ') : 'no';
    },
    update: () => {
      const shuffled = friends.slice().sort(() => 0.5 - Math.random());
      const count = Math.floor(Math.random() * friends.length) + 1;
      setTimeout(() => bound.friends = shuffled.slice(0, count), 0);
    },
    selectTab: (tabId) => {
      bound.currentTab = tabId;
      const example = bound.examples.find(ex => ex.id === tabId);
      if (example) {
        bound.currentExample = {
          originalHtml: formatHTML(example.originalHtml),
          interpolatedHtml: formatHTML(example.interpolatedHtml),
          templateId: example.templateId,
        };
        updateStateDump();
      }
    }
  });

  // Capture original HTML for each example
  setTimeout(() => {
    const exampleNodes = document.querySelectorAll('#example-definitions [vln-diff]');
    exampleNodes.forEach((node, idx) => {
      if (bound.examples[idx]) {
        bound.examples[idx].originalHtml = node.outerHTML;
      }
    });

    // Build tabs from examples
    bound.tabs = bound.examples.map(ex => ({
      id: ex.id,
      title: ex.title
    }));

    // Select first tab
    if (bound.tabs.length > 0) {
      bound.selectTab(bound.tabs[0].id);
    }
  }, 200);

  // Format HTML for display
  function formatHTML(html) {
    if (!html) return '<pre class="text-gray-500">Loading...</pre>';
    return prettier.format(html, {
      parser: 'html',
      plugins: prettierPlugins
    }).then(formatted => {
      const escaped = formatted
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
      return `<pre><code class="language-markup">${escaped}</code></pre>`;
    }).catch(() => {
      const escaped = (html || '')
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
      return `<pre><code class="language-markup">${escaped}</code></pre>`;
    });
  }

  // Update state dump with syntax highlighting
  function updateStateDump() {
    const stateDump = document.getElementById('state-dump');
    if (!stateDump) return;

    // Get clean state (exclude functions and internal stuff)
    const cleanState = {};
    for (const key in bound) {
      if (typeof bound[key] === 'function') continue;
      if (key === 'examples' || key === 'tabs' || key === 'currentExample') continue;
      cleanState[key] = bound[key];
    }

    const json = JSON.stringify(cleanState, null, 2);
    const escaped = json
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");

    stateDump.innerHTML = `<pre><code class="language-javascript">${escaped}</code></pre>`;
    Prism.highlightAllUnder(stateDump);
  }

  // Watch for state changes and update dump
  Velin.on('afterProcessNode', () => {
    if (bound.currentTab) {
      updateStateDump();
    }
  });
</script>

</html>